-- Serviços
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer
local Mouse = Player:GetMouse()

-- Funções auxiliares
local function AddConnection(signal, func)
    return signal:Connect(func)
end

local function Round(num, numDecimalPlaces)
    return tonumber(string.format("%." .. (numDecimalPlaces or 0) .. "f", num))
end

local function CheckKey(list, key)
    for _, v in pairs(list) do
        if v == key then return true end
    end
    return false
end

-- ===== PARTE 1 – SLIDER, DROPDOWN, BIND =====

-- Slider
SliderBar.Active = true
SliderBar.Selectable = true
SliderDrag.Active = true
SliderDrag.Selectable = true
local Dragging = false

SliderBar.InputBegan:Connect(function(Input)
    if Input.UserInputType == Enum.UserInputType.MouseButton1 then 
        Dragging = true 
    end 
end)

SliderBar.InputEnded:Connect(function(Input) 
    if Input.UserInputType == Enum.UserInputType.MouseButton1 then 
        Dragging = false 
    end 
end)

UserInputService.InputChanged:Connect(function(Input)
    if Dragging and Input.UserInputType == Enum.UserInputType.MouseMovement then 
        local SizeScale = math.clamp((Input.Position.X - SliderBar.AbsolutePosition.X) / SliderBar.AbsoluteSize.X, 0, 1)
        Slider:Set(SliderConfig.Min + ((SliderConfig.Max - SliderConfig.Min) * SizeScale)) 
        SaveCfg(game.GameId)
    end
end)

function Slider:Set(Value)
    self.Value = math.clamp(Round(Value, SliderConfig.Increment), SliderConfig.Min, SliderConfig.Max)
    TweenService:Create(SliderDrag,TweenInfo.new(.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),{
        Size = UDim2.fromScale((self.Value - SliderConfig.Min) / (SliderConfig.Max - SliderConfig.Min), 1)
    }):Play()
    SliderBar.Value.Text = tostring(self.Value) .. " " .. SliderConfig.ValueName
    SliderDrag.Value.Text = tostring(self.Value) .. " " .. SliderConfig.ValueName
    SliderConfig.Callback(self.Value)
end      

Slider:Set(Slider.Value)
if SliderConfig.Flag then
    OrionLib.Flags[SliderConfig.Flag] = Slider
end

-- Dropdown
Click.Active = true
Click.Selectable = true

AddConnection(Click.MouseButton1Click, function()
    Dropdown.Toggled = not Dropdown.Toggled
    DropdownFrame.F.Line.Visible = Dropdown.Toggled
    TweenService:Create(DropdownFrame.F.Ico,TweenInfo.new(.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),{
        Rotation = Dropdown.Toggled and 180 or 0
    }):Play()
    if #Dropdown.Options > MaxElements then
        TweenService:Create(DropdownFrame,TweenInfo.new(.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),{
            Size = Dropdown.Toggled and UDim2.new(1, 0, 0, 38 + (MaxElements * 28)) or UDim2.new(1, 0, 0, 38)
        }):Play()
    else
        TweenService:Create(DropdownFrame,TweenInfo.new(.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),{
            Size = Dropdown.Toggled and UDim2.new(1, 0, 0, DropdownList.AbsoluteContentSize.Y + 38) or UDim2.new(1, 0, 0, 38)
        }):Play()
    end
end)

for _, OptionBtn in pairs(Dropdown.Buttons) do
    OptionBtn.Active = true
    OptionBtn.Selectable = true
end

-- Bind
Click.Active = true
Click.Selectable = true
BindBox.Active = true
BindBox.Selectable = true

AddConnection(UserInputService.InputBegan, function(Input)
    if UserInputService:GetFocusedTextBox() then return end
    if (Input.KeyCode.Name == Bind.Value or Input.UserInputType.Name == Bind.Value) and not Bind.Binding then
        if BindConfig.Hold then
            Holding = true
            BindConfig.Callback(Holding)
        else
            BindConfig.Callback()
        end
    elseif Bind.Binding then
        local Key
        pcall(function()
            if not CheckKey(BlacklistedKeys, Input.KeyCode) then
                Key = Input.KeyCode
            end
        end)
        pcall(function()
            if CheckKey(WhitelistedMouse, Input.UserInputType) and not Key then
                Key = Input.UserInputType
            end
        end)
        Key = Key or Bind.Value
        Bind:Set(Key)
        SaveCfg(game.GameId)
    end
end)

-- ===== PARTE 2 – TEXTBOX E COLORPICKER =====

-- Textbox
Click.Active = true
Click.Selectable = true
TextboxActual.Active = true
TextboxActual.Selectable = true

AddConnection(TextboxActual:GetPropertyChangedSignal("Text"), function()
    TweenService:Create(TextContainer, TweenInfo.new(0.45, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {
        Size = UDim2.new(0, TextboxActual.TextBounds.X + 16, 0, 24)
    }):Play()
end)

AddConnection(TextboxActual.FocusLost, function()
    TextboxConfig.Callback(TextboxActual.Text)
    if TextboxConfig.TextDisappear then
        TextboxActual.Text = ""
    end
end)

TextboxActual.Text = TextboxConfig.Default

-- Colorpicker
Click.Active = true
Click.Selectable = true
Color.Active = true
Color.Selectable = true
Hue.Active = true
Hue.Selectable = true

AddConnection(Click.MouseButton1Click, function()
    Colorpicker.Toggled = not Colorpicker.Toggled
    TweenService:Create(ColorpickerFrame,TweenInfo.new(.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),{
        Size = Colorpicker.Toggled and UDim2.new(1, 0, 0, 148) or UDim2.new(1, 0, 0, 38)
    }):Play()
    Color.Visible = Colorpicker.Toggled
    Hue.Visible = Colorpicker.Toggled
    ColorpickerFrame.F.Line.Visible = Colorpicker.Toggled
end)

local function UpdateColorPicker()
    ColorpickerBox.BackgroundColor3 = Color3.fromHSV(ColorH, ColorS, ColorV)
    Color.BackgroundColor3 = Color3.fromHSV(ColorH, 1, 1)
    Colorpicker:Set(ColorpickerBox.BackgroundColor3)
    ColorpickerConfig.Callback(ColorpickerBox.BackgroundColor3)
    SaveCfg(game.GameId)
end

AddConnection(Color.InputBegan, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if ColorInput then ColorInput:Disconnect() end
        ColorInput = AddConnection(RunService.RenderStepped, function()
            local ColorX = math.clamp(Mouse.X - Color.AbsolutePosition.X, 0, Color.AbsoluteSize.X) / Color.AbsoluteSize.X
            local ColorY = math.clamp(Mouse.Y - Color.AbsolutePosition.Y, 0, Color.AbsoluteSize.Y) / Color.AbsoluteSize.Y
            ColorSelection.Position = UDim2.new(ColorX, 0, ColorY, 0)
            ColorS = ColorX
            ColorV = 1 - ColorY
            UpdateColorPicker()
        end)
    end
end)

AddConnection(Color.InputEnded, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if ColorInput then ColorInput:Disconnect() end
    end
end)

AddConnection(Hue.InputBegan, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if HueInput then HueInput:Disconnect() end
        HueInput = AddConnection(RunService.RenderStepped, function()
            local HueY = math.clamp(Mouse.Y - Hue.AbsolutePosition.Y, 0, Hue.AbsoluteSize.Y) / Hue.AbsoluteSize.Y
            HueSelection.Position = UDim2.new(0.5, 0, HueY, 0)
            ColorH = 1 - HueY
            UpdateColorPicker()
        end)
    end
end)

AddConnection(Hue.InputEnded, function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if HueInput then HueInput:Disconnect() end
    end
end)
