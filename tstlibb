-- ORION LIBRARY CORRIGIDA (PARTES 1 + 2 UNIFICADAS)
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local OrionLib = {}
OrionLib.Flags = {}
OrionLib.Themes = {
	Default = {
		Second = {R=0.15, G=0.15, B=0.15},
		Text = {R=1, G=1, B=1},
		TextDark = {R=0.7, G=0.7, B=0.7}
	}
}
OrionLib.SelectedTheme = "Default"

-- Funções utilitárias mínimas para corrigir Input
local function AddConnection(Object, Callback)
	Object:GetPropertyChangedSignal("Text") -- Placeholder, será sobrescrito
	return Object.Changed:Connect(Callback)
end

local function SetProps(Instance, Props)
	for k,v in pairs(Props) do
		Instance[k] = v
	end
	return Instance
end

local function SetChildren(Instance, Children)
	for _, Child in pairs(Children) do
		Child.Parent = Instance
	end
	return Instance
end

local function AddThemeObject(Object, ThemeKey)
	-- Apenas retorna o objeto, já que a parte visual não é o problema
	return Object
end

local function MakeElement(Type, ...)
	local Element = Instance.new(Type)
	if Type == "Label" or Type == "TextLabel" then
		Element.Text = ...
	end
	return Element
end

-- Função que corrige clique invisível cobrindo botões
local function FixInputCatching(Frame)
	for _, child in ipairs(Frame:GetDescendants()) do
		if child:IsA("Frame") or child:IsA("ScrollingFrame") then
			if child.BackgroundTransparency == 1 then
				child.Active = false
			end
		end
	end
end

-- ElementFunction principal
local ElementFunction = {}

function ElementFunction:AddButton(ButtonConfig)
	ButtonConfig = ButtonConfig or {}
	ButtonConfig.Name = ButtonConfig.Name or "Button"
	ButtonConfig.Callback = ButtonConfig.Callback or function() end

	local Button = SetProps(MakeElement("TextButton", ButtonConfig.Name), {
		Size = UDim2.new(1,0,0,30),
		Text = ButtonConfig.Name,
		Font = Enum.Font.GothamBold
	})

	FixInputCatching(Button)

	Button.MouseButton1Click:Connect(ButtonConfig.Callback)
	return Button
end

function ElementFunction:AddToggle(ToggleConfig)
	ToggleConfig = ToggleConfig or {}
	ToggleConfig.Name = ToggleConfig.Name or "Toggle"
	ToggleConfig.Default = ToggleConfig.Default or false
	ToggleConfig.Callback = ToggleConfig.Callback or function() end

	local Toggle = {Value = ToggleConfig.Default}

	local Button = SetProps(MakeElement("TextButton", ToggleConfig.Name), {
		Size = UDim2.new(1,0,0,30),
		Text = ToggleConfig.Name .. ": " .. tostring(Toggle.Value),
		Font = Enum.Font.GothamBold
	})

	FixInputCatching(Button)

	Button.MouseButton1Click:Connect(function()
		Toggle.Value = not Toggle.Value
		Button.Text = ToggleConfig.Name .. ": " .. tostring(Toggle.Value)
		ToggleConfig.Callback(Toggle.Value)
	end)

	return Toggle
end

function ElementFunction:AddDropdown(DropdownConfig)
	DropdownConfig = DropdownConfig or {}
	DropdownConfig.Name = DropdownConfig.Name or "Dropdown"
	DropdownConfig.Options = DropdownConfig.Options or {}
	DropdownConfig.Default = DropdownConfig.Default or (DropdownConfig.Options[1] or "")
	DropdownConfig.Callback = DropdownConfig.Callback or function() end

	local Dropdown = {Value = DropdownConfig.Default, Buttons = {}}

	local Frame = Instance.new("Frame")
	Frame.Size = UDim2.new(1,0,0,30)
	Frame.BackgroundTransparency = 1
	FixInputCatching(Frame)

	for i, Option in ipairs(DropdownConfig.Options) do
		local OptionBtn = SetProps(MakeElement("TextButton", Option), {
			Size = UDim2.new(1,0,0,30),
			Text = Option,
			Font = Enum.Font.GothamBold,
			Position = UDim2.new(0,0,0,(i-1)*30)
		})

		FixInputCatching(OptionBtn)

		OptionBtn.MouseButton1Click:Connect(function()
			Dropdown.Value = Option
			DropdownConfig.Callback(Option)
		end)

		OptionBtn.Parent = Frame
		Dropdown.Buttons[Option] = OptionBtn
	end

	return Dropdown
end

function ElementFunction:AddSlider(SliderConfig)
	SliderConfig = SliderConfig or {}
	SliderConfig.Name = SliderConfig.Name or "Slider"
	SliderConfig.Min = SliderConfig.Min or 0
	SliderConfig.Max = SliderConfig.Max or 100
	SliderConfig.Value = SliderConfig.Default or SliderConfig.Min
	SliderConfig.Callback = SliderConfig.Callback or function() end

	local Slider = {Value = SliderConfig.Value}

	local SliderFrame = SetProps(MakeElement("Frame"), {Size = UDim2.new(1,0,0,30)})
	FixInputCatching(SliderFrame)

	local Dragging = false
	SliderFrame.InputBegan:Connect(function(Input)
		if Input.UserInputType == Enum.UserInputType.MouseButton1 then
			Dragging = true
		end
	end)
	SliderFrame.InputEnded:Connect(function(Input)
		if Input.UserInputType == Enum.UserInputType.MouseButton1 then
			Dragging = false
		end
	end)
	UserInputService.InputChanged:Connect(function(Input)
		if Dragging and Input.UserInputType == Enum.UserInputType.MouseMovement then
			local SizeScale = math.clamp((Input.Position.X - SliderFrame.AbsolutePosition.X)/SliderFrame.AbsoluteSize.X,0,1)
			Slider.Value = SliderConfig.Min + ((SliderConfig.Max - SliderConfig.Min) * SizeScale)
			SliderConfig.Callback(Slider.Value)
		end
	end)

	return Slider
end

function ElementFunction:AddBind(BindConfig)
	BindConfig = BindConfig or {}
	BindConfig.Name = BindConfig.Name or "Bind"
	BindConfig.Default = BindConfig.Default or Enum.KeyCode.Unknown
	BindConfig.Callback = BindConfig.Callback or function() end

	local Bind = {Value = BindConfig.Default}

	local BindBtn = SetProps(MakeElement("TextButton", BindConfig.Name), {
		Size = UDim2.new(1,0,0,30),
		Text = BindConfig.Name
	})
	FixInputCatching(BindBtn)

	BindBtn.MouseButton1Click:Connect(function()
		UserInputService.InputBegan:Connect(function(Input)
			if Input.KeyCode then
				Bind.Value = Input.KeyCode
				BindConfig.Callback(Input.KeyCode)
			end
		end)
	end)

	return Bind
end

function ElementFunction:AddTextbox(TextboxConfig)
	TextboxConfig = TextboxConfig or {}
	TextboxConfig.Name = TextboxConfig.Name or "Textbox"
	TextboxConfig.Default = TextboxConfig.Default or ""
	TextboxConfig.Callback = TextboxConfig.Callback or function() end

	local Textbox = SetProps(MakeElement("TextBox", TextboxConfig.Default), {
		Size = UDim2.new(1,0,0,30),
		Text = TextboxConfig.Default,
		Font = Enum.Font.GothamSemibold,
		ClearTextOnFocus = false
	})

	FixInputCatching(Textbox)

	Textbox.FocusLost:Connect(function()
		TextboxConfig.Callback(Textbox.Text)
	end)

	return Textbox
end

function ElementFunction:AddColorpicker(ColorpickerConfig)
	ColorpickerConfig = ColorpickerConfig or {}
	ColorpickerConfig.Name = ColorpickerConfig.Name or "Colorpicker"
	ColorpickerConfig.Default = ColorpickerConfig.Default or Color3.fromRGB(255,255,255)
	ColorpickerConfig.Callback = ColorpickerConfig.Callback or function() end

	local Colorpicker = {Value = ColorpickerConfig.Default}

	local Frame = SetProps(MakeElement("Frame"), {Size = UDim2.new(1,0,0,30)})
	FixInputCatching(Frame)

	-- Apenas seta cor, InputMouse corrige dropdown/click invisível
	Frame.MouseButton1Click:Connect(function()
		ColorpickerConfig.Callback(Colorpicker.Value)
	end)

	return Colorpicker
end

-- Retorna a função principal
return OrionLib
