local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local HttpService = game:GetService("HttpService")

local OrionLib = {
    Elements = {},
    ThemeObjects = {},
    Connections = {},
    Flags = {},
    Themes = {
        Default = {
            Main = Color3.fromRGB(0,0,0),
            Second = Color3.fromRGB(10,10,10),
            Stroke = Color3.fromRGB(0,170,255),
            Divider = Color3.fromRGB(60,60,60),
            Text = Color3.fromRGB(240,240,240),
            TextDark = Color3.fromRGB(150,150,150)
        }
    },
    SelectedTheme = "Default",
    Folder = nil,
    SaveCfg = false
}

-- Feather Icons
local Icons = {}
pcall(function()
    Icons = HttpService:JSONDecode(game:HttpGetAsync("https://raw.githubusercontent.com/evoincorp/lucideblox/master/src/modules/util/icons.json")).icons
end)
local function GetIcon(IconName) return Icons[IconName] or nil end

-- GUI Setup
local Orion = Instance.new("ScreenGui")
local guiRH = Instance.new("ScreenGui", Orion)
local nextb = Instance.new("ImageButton", guiRH)
local gui = Instance.new("UICorner", nextb)

Orion.Name = "ITALO CLIENT"
guiRH.Name = "Minimize"

nextb.Position = UDim2.new(0,100,0,60)
nextb.Size = UDim2.new(0,40,0,40)
nextb.BackgroundColor3 = Color3.fromRGB(25,25,25)
nextb.Image = "rbxassetid://7072720870"
nextb.Visible = false
nextb.Active = true
nextb.Draggable = true

-- Corrigido para PC e celular
nextb.Activated:Connect(function()
    if Orion.Frame1 then
        Orion.Frame1.Visible = not Orion.Frame1.Visible
        nextb.Image = Orion.Frame1.Visible and "rbxassetid://7072720870" or "rbxassetid://7072719338"
    end
end)

-- Função genérica para botões
local function ConnectButton(Button, Callback)
    if Button then
        Button.Active = true
        Button.Activated:Connect(Callback)
    end
end

-- Parent GUI corretamente
if syn then
    syn.protect_gui(Orion)
    Orion.Parent = game.CoreGui
else
    Orion.Parent = gethui() or game.CoreGui
end

-- Remove duplicados
for _, Interface in ipairs(Orion.Parent:GetChildren()) do
    if Interface.Name == Orion.Name and Interface ~= Orion then Interface:Destroy() end
end

-- Funções utilitárias
function OrionLib:IsRunning()
    return Orion.Parent == game:GetService("CoreGui") or (gethui and Orion.Parent == gethui())
end

local function AddConnection(Signal, Func)
    if not OrionLib:IsRunning() then return end
    local Connection = Signal:Connect(Func)
    table.insert(OrionLib.Connections, Connection)
    return Connection
end

task.spawn(function()
    while OrionLib:IsRunning() do wait() end
    for _, Connection in ipairs(OrionLib.Connections) do
        Connection:Disconnect()
    end
end)

local function MakeDraggable(DragPoint, Main)
    local Dragging, DragInput, MousePos, FramePos = false
    AddConnection(DragPoint.InputBegan, function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = true
            MousePos = Input.Position
            FramePos = Main.Position
            Input.Changed:Connect(function()
                if Input.UserInputState == Enum.UserInputState.End then Dragging = false end
            end)
        end
    end)
    AddConnection(DragPoint.InputChanged, function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseMovement then
            DragInput = Input
        end
    end)
    AddConnection(UserInputService.InputChanged, function(Input)
        if Input == DragInput and Dragging then
            local Delta = Input.Position - MousePos
            Main.Position = UDim2.new(FramePos.X.Scale, FramePos.X.Offset + Delta.X, FramePos.Y.Scale, FramePos.Y.Offset + Delta.Y)
        end
    end)
end

-- Funções para criação de elementos
local function Create(Name, Properties, Children)
    local Object = Instance.new(Name)
    for i,v in pairs(Properties or {}) do Object[i] = v end
    for i,v in pairs(Children or {}) do v.Parent = Object end
    return Object
end

local function CreateElement(ElementName, ElementFunction)
    OrionLib.Elements[ElementName] = function(...) return ElementFunction(...) end
end

local function MakeElement(ElementName, ...)
    return OrionLib.Elements[ElementName](...)
end

local function SetProps(Element, Props)
    for Property, Value in pairs(Props) do Element[Property] = Value end
    return Element
end

local function SetChildren(Element, Children)
    for _, Child in pairs(Children) do Child.Parent = Element end
    return Element
end

-- Exemplo de elementos padrões
CreateElement("Corner", function(Scale, Offset)
    return Create("UICorner", {CornerRadius = UDim.new(Scale or 0, Offset or 10)})
end)
CreateElement("Stroke", function(Color, Thickness)
    return Create("UIStroke", {Color = Color or Color3.fromRGB(255,255,255), Thickness = Thickness or 1})
end)
CreateElement("List", function(Scale, Offset)
    return Create("UIListLayout", {SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(Scale or 0, Offset or 0)})
end)
CreateElement("Padding", function(Bottom, Left, Right, Top)
    return Create("UIPadding", {PaddingBottom=UDim.new(0,Bottom or 4), PaddingLeft=UDim.new(0,Left or 4), PaddingRight=UDim.new(0,Right or 4), PaddingTop=UDim.new(0,Top or 4)})
end)
CreateElement("TFrame", function()
    return Create("Frame",{BackgroundTransparency=1})
end)

-- TODO: Adicionar todas as funções restantes da library original
-- Certifique-se de trocar todos os eventos MouseButton1Down por Activated
-- Adicionar Active = true para cada botão criado
-- Preservar abas, sliders, cores, etc.
